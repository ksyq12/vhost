{{ if .SSL }}<VirtualHost *:80>
    ServerName {{ .Domain }}{{ range .Aliases }}
    ServerAlias {{ . }}{{ end }}

    # Redirect to HTTPS
    Redirect permanent / https://{{ .Domain }}/
</VirtualHost>

<VirtualHost *:443>
    ServerName {{ .Domain }}{{ range .Aliases }}
    ServerAlias {{ . }}{{ end }}

    DocumentRoot {{ .Root }}

    <Directory {{ .Root }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    DirectoryIndex index.php index.html index.htm

    # PHP-FPM Configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php{{ .PHPVersion }}-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Deny access to .htaccess
    <FilesMatch "^\.ht">
        Require all denied
    </FilesMatch>

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ .SSLCert }}
    SSLCertificateKeyFile {{ .SSLKey }}
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/{{ .Domain }}-error.log
    CustomLog ${APACHE_LOG_DIR}/{{ .Domain }}-access.log combined
</VirtualHost>
{{ else }}<VirtualHost *:80>
    ServerName {{ .Domain }}{{ range .Aliases }}
    ServerAlias {{ . }}{{ end }}

    DocumentRoot {{ .Root }}

    <Directory {{ .Root }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    DirectoryIndex index.php index.html index.htm

    # PHP-FPM Configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php{{ .PHPVersion }}-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Deny access to .htaccess
    <FilesMatch "^\.ht">
        Require all denied
    </FilesMatch>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/{{ .Domain }}-error.log
    CustomLog ${APACHE_LOG_DIR}/{{ .Domain }}-access.log combined
</VirtualHost>
{{ end }}
